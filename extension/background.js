(()=>{"use strict";var e,t=function(){function e(e){this.name=e,this.callbacks=[]}return e.prototype.getCallbacks=function(){return this.callbacks},e.prototype.registerCallback=function(e){this.callbacks.push(e)},e}(),n=function(){function e(e){void 0===e&&(e=[]);var t=this;this.events={},this.emitEvent=function(e,n){t.events[e]&&t.events[e].getCallbacks().forEach((function(e){return e(n)}))},this.registerEvent(e)}return e.prototype.registerEvent=function(e){for(var n=0,r=e;n<r.length;n++){var o=r[n],i=new t(o);this.events[o]=i}},e.prototype.addEventListener=function(e,t){if(!this.events[e])throw new Error("Event ".concat(e," is not registered."));this.events[e].registerCallback(t)},e}(),r=(e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}),o=function(e){function t(t,n,r){void 0===r&&(r=!0);var o=e.call(this)||this;return o.origin=t,o.defaultRecipient=n,o.isAllowed=r,o.queue=[],o}return r(t,e),t.directSend=function(e,n,r){new t(e,n).send(r)},t.prototype.listen=function(){var e=this;chrome.runtime.onMessage.addListener((function(t,n){console.log("message",t),t.recipient===e.origin&&e.receive(t)}))},t.prototype.setIsAllowed=function(e){this.isAllowed=e,this.dispatch()},t.prototype.dispatch=function(){for(var e=0,t=this.queue;e<t.length;e++){var n=t[e],r=void 0;n.recipient?(r=n.recipient,delete n.recipient):r=this.defaultRecipient,chrome.runtime.sendMessage({origin:this.origin,recipient:r,content:n})}this.queue=[]},t.prototype.send=function(e){this.addToQueue(e),this.isAllowed&&this.dispatch()},t.prototype.addToQueue=function(e){if(Array.isArray(e))for(var t=0,n=e;t<n.length;t++){var r=n[t];this.queue.push(r)}else this.queue.push(e)},t.prototype.receive=function(e){var t=Object.keys(e.content)[0];this.emitEvent(t,{origin:e.origin,data:e.content[t]})},t}(n);!function(){var e=this,t=new o("background","active-page",!1);t.listen(),t.registerEvent(["handshake","request-stored-data","store-data","remove-stored-data"]),t.addEventListener("handshake",(function(e){console.log("background received handshake"),t.setIsAllowed(!0),t.send({handshake:!0})})),t.addEventListener("request-stored-data",(function(n){return r=e,o=void 0,a=function(){var e;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(e,t){chrome.storage.local.get(n.data,(function(n){if(chrome.runtime.lastError)return t(chrome.runtime.lastError);e(n)}))}))];case 1:return e=r.sent(),t.send({recipient:n.origin,"get-stored-data":e}),[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(a.next(e))}catch(e){t(e)}}function s(e){try{c(a.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,s)}c((a=a.apply(r,o||[])).next())}));var r,o,i,a})),t.addEventListener("store-data",(function(e){chrome.storage.local.set(e.data)})),t.addEventListener("remove-stored-data",(function(e){chrome.storage.local.remove(e.data)}))}()})();